<!DOCTYPE html>
<html>
    <head>
        <script src="https://aarondavidnewman.github.io/vexflow_smoosic/releases/vexflow-debug.js"></script>
    </head>
    <body>
        <h1>Chord Progression and Analysis Tool</h1>

        <form action="{{url_for('analysis')}}" method="POST" id="chord-builder-form">
            <h2>Chord Progression Builder</h2>
            <label for="keyOptions">Key </label>
            <select id="keyOptions" name="key">
                <option value="C" selected>C Major</option>
                <option value="G">G Major</option>
                <option value="D">D Major</option>
                <option value="A">A Major</option>
                <option value="E">E Major</option>
                <option value="B">B Major</option>
                <option value="F#">F# Major</option>
                <option value="C#">C# Major</option>
                <option value="F">F Major</option>
                <option value="Bb">Bb Major</option>
                <option value="Eb">Eb Major</option>
                <option value="Ab">Ab Major</option>
                <option value="Db">Db Major</option>
                <option value="Gb">Gb Major</option>
                <option value="Cb">Cb Major</option>
                <option value="Am">A minor</option>
                <option value="Em">E minor</option>
                <option value="F#m">F# minor</option>
                <option value="C#m">C# minor</option>
                <option value="G#m">G# minor</option>
                <option value="D#m">D# minor</option>
                <option value="A#m">A# minor</option>
                <option value="Dm">D minor</option>
                <option value="Gm">G minor</option>
                <option value="Cm">C minor</option>
                <option value="Fm">F minor</option>
                <option value="Bbm">Bb minor</option>
                <option value="Ebm">Eb minor</option>
                <option value="Abm">Ab minor</option>
            </select>
            <div id="progression-chords">
                <label for="chordInput">Chord:</label>
                <input id="chordInput" type="text" name="chord">
            </div>
            <button id="addChordBtn">Add Chord</button>
            <input type="submit" value="Generate Progression">
        </form>
        <div id='stave-svg'></div>
        <script>

            let addBtn = document.getElementById('addChordBtn');

            addBtn.onclick = (ev) => {
                ev.preventDefault();

                let chordDiv = document.getElementById('progression-chords');
                console.log('Add a chord!');

                let newChordLabel = document.createElement('label');
                newChordLabel.setAttribute('for', 'newChord2');
                newChordLabel.innerText = "Chord:";

                let newChordInput = document.createElement('input');
                newChordInput.setAttribute('id', 'newChord2');
                newChordInput.setAttribute('name', 'chord');

                chordDiv.appendChild(newChordLabel);
                chordDiv.appendChild(newChordInput);
            }
        </script>

        <!-- Script to build the stave -->
        <script>

            let data = null;
            let key = null;
            let chord_notes = [];

            let VF = Vex.Flow;

            "{% if data is defined and data.key is defined %}"
                data = "{{data}}";
                key = "{{data.key}}";
            "{% endif %}";

            "{% if data is defined and data.chords is defined %}"
                "{% for chord in data.chords['chords'] %}"
                    chord_notes.push({'name': "{{ chord.name }}", 'numeral': "{{ chord.numeral }}", 'notes': "{{ chord.notes }}"})
                "{% endfor %}"
            "{% endif %}"

            function buildStave(key, chords) {

                //The div to put the music stave svg inside
                let div = document.getElementById('stave-svg');

                //Create the svg renderer
                let renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
                renderer.resize(500, 500);

                let context = renderer.getContext();

                //Create the staves
                let trebleStave = new VF.Stave(15, 40, 460);
                trebleStave.addClef('treble').addTimeSignature('4/4');
                trebleStave.addKeySignature(key);
                trebleStave.setContext(context).draw();

                let bassStave = new VF.Stave(15, 120, 460);
                bassStave.addClef('bass').addTimeSignature('4/4');
                bassStave.addKeySignature(key);
                bassStave.setContext(context).draw();

                //Draw the stave connectors to form the grand staff
                let brace = new Vex.Flow.StaveConnector(trebleStave, bassStave).setType(3);
                let lineLeft = new Vex.Flow.StaveConnector(trebleStave, bassStave).setType(1);
                let lineRight = new Vex.Flow.StaveConnector(trebleStave, bassStave).setType(6);
                
                brace.setContext(context).draw();
                lineLeft.setContext(context).draw();
                lineRight.setContext(context).draw();

                let svgNotes = [];
                let trebleNotes = [];
                let bassNotes = [];

                //Format each chord's notes to the notation for VexFlow expected
                getFormattedChords(chords);

                let voices = getPianoVoices(chords);

                //Format and justify the notes to 400 pixels
                let trebleFormatter = new VF.Formatter().joinVoices([voices[0]]).format([voices[0]], 400);
                let bassFormatter = new VF.Formatter().joinVoices([voices[1]]).format([voices[1]], 400);

                let bassBeams = VF.Beam.generateBeams(voices[0].tickables)

                voices[0].draw(context, trebleStave);
                voices[1].draw(context, bassStave);
          
                bassBeams.forEach(function(beam) {
                    beam.setContext(context).draw();
                });
            }

            /* Function: getPianoVoices
             * Description: This function separates notes in each chord to place them within the treble or bass clef.
            */ 
            function getPianoVoices(chords) {

                let voices = [];
                let trebleVoiceNotes = [];
                let bassVoiceNotes = [];
               
                //Iterate through each chord
                for (let chord of chords) {
                    
                    let trebleNotes = [];
                    let bassNotes = [];

                    chord.notes.forEach(function (note, i) {
                        let staveNote;
                        
                        note.charAt(note.length - 1) >= 4 ? trebleNotes.push(note) : bassNotes.push(note);    
                    })

                    if (trebleNotes.length > 0) {
                        trebleVoiceNotes.push(new VF.StaveNote({clef: 'treble', keys: trebleNotes, duration: 'q'}));
                    }

                    else {
                        trebleVoiceNotes.push(new VF.GhostNote({clef: 'treble', duration: 'q'}))
                    }

                    if (bassNotes.length > 0) {
                        bassVoiceNotes.push(new VF.StaveNote({clef: 'bass', keys: bassNotes, duration: 'q'}));
                    }

                    else {
                        bassVoiceNotes.push(new VF.GhostNote({clef: 'bass', duration: 'q'}))
                    }
                }

                //Add chord names to each chord
                chords.forEach(function (chord, i) {

                    let chordSymbol = new VF.ChordSymbol()
                        .setFontSize(14)
                        .addText(chord.name)
                        .setVertical('bottom')
                        .setHorizontal('center');
                        
                    bassVoiceNotes[i].addModifier(0, chordSymbol);
                });

                //Build the voices to display
                voices[0] = new VF.Voice({num_beats: 4, beat_value: 4})
                    .setStrict(false)
                    .addTickables(trebleVoiceNotes);

                voices[1] = new VF.Voice({num_beats: 4, beat_value: 4})
                    .setStrict(false)
                    .addTickables(bassVoiceNotes);

                return voices;
            }

            /* Function: getSATBVoices
             * Description: This function separates notes in each chord to match SATB voicing rules.
            */ 
            function getSATBVoices() {

                let voices = [];

                let sopranoNotes = [];
                let altoNotes = [];
                let tenorNotes = [];
                let bassNotes = [];

                for (let chord of chords) {
                    bassNotes.push(new VF.StaveNote({clef: 'bass', keys: chord.notes[0], duration: 'q'}));
                    tenorNotes.push(new VF.StaveNote({clef: 'bass', keys: chord.notes[1], duration: 'q'}));
                    altoNotes.push(new VF.StaveNote({clef: 'treble', keys: chord.notes[2], duration: 'q'}));
                    sopranoNotes.push(new VF.StaveNote({clef: 'treble', keys: chord.notes[3], duration: 'q'}));
                }

                //Create voices with each line of notes
                voices[0] = new VF.Voice({num_beats: 4, beat_value: 4})
                    .setStrict(false)
                    .addTickables(bassNotes);

                voices[1] = new VF.Voice({num_beats: 4, beat_value: 4})
                    .setStrict(false)
                    .addTickables(tenorNotes);
            
                voices[2] = new VF.Voice({num_beats: 4, beat_value: 4})
                    .setStrict(false)
                    .addTickables(altoNotes);

                voices[3] = new VF.Voice({num_beats: 4, beat_value: 4})
                    .setStrict(false)
                    .addTickables(sopranoNotes);

                return voices;
            }

            /* Function: getFormattedChords
             * Description: This function is used to format the notes in each chord for display in VexFlow.
             * The notes are modified directly in each chord object.
            */ 
            function getFormattedChords(chords) {

                let formattedChords = [];

                for (let chord of chords) {
    
                    let chordNotes = chord.notes;
                    let formattedNotes = [];

                    //Reformat each note --> '<letter>/<octave>' i.e. c/4
                    for (let note of chordNotes.split(',')) {
                        note = note.trim()
                        note = note.toLowerCase();
                        note = note.substr(0, note.length - 1) + '/' + note.substr(-1);
                        formattedNotes.push(note);
                    }

                    chord.notes = formattedNotes;
                }
            }

            if (key !== null && chord_notes.length > 0) {
                buildStave(key, chord_notes);
            }
            
        </script>
    </body>
</html>